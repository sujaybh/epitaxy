import pyvisa
import time

rm = pyvisa.ResourceManager()
instr = rm.open_resource('GPIB0::17::INSTR')

# Increase timeout and clear buffers
instr.timeout = 20000 
instr.write("BC") 

# Re-send setup to ensure clean state
instr.write("TR3, IB2, BL1")
instr.write("PS-5, PP5, PE.5, PL3E-3, PD3E-3")
instr.write("SW1")

print("Waiting for sweep...")
while not (instr.stb & 1):
    time.sleep(0.5)

# 1. Get the Block Status (This usually works because it's short)
instr.write("BS?")
meta = instr.read().strip()
print(f"Metadata received: {meta}")

# 2. THE FIX: Read the entire block at once as raw bytes
# Instead of read() which looks for \n, we pull a large chunk
try:
    # We ask for 1024 bytes (enough for 21 readings) 
    # and let the GPIB EOI (End of Identity) signal terminate the read.
    raw_payload = instr.read_bytes(1024, break_on_termchar=False)
    
    # Convert bytes to string and split by the comma delimiters 
    # mentioned in Table 3-33 
    decoded_data = raw_payload.decode('ascii')
    data_points = decoded_data.split(',')
    
    print(f"Successfully captured {len(data_points)} segments.")
    for idx, val in enumerate(data_points):
        print(f"Reading {idx+1}: {val}")
        
except Exception as e:
    print(f"Read failed: {e}")

instr.close()
