import pyvisa
import time

rm = pyvisa.ResourceManager()
instr = rm.open_resource('GPIB0::17::INSTR')

# 1. Set a long timeout and clear the buffer
instr.timeout = 20000 
instr.write("BC") # Buffer Clear 

# 2. Configure the 4280A
instr.write("TR3, IB2, BL1") # [cite: 27, 33, 38]
instr.write("PS-5, PP5, PE.5, PL3E-3, PD3E-3") # [cite: 48, 59]
instr.write("SW1") # Start Sweep [cite: 33]

print("Sweeping...")

# 3. Wait for Data Ready bit
while not (instr.stb & 1): # [cite: 43]
    time.sleep(0.5)

# 4. Handle the BS? response carefully
# Instead of query(), we write and read separately to control the flow
instr.write("BS?")
block_info = instr.read() 
print(f"Block Info: {block_info}") # Should be NM0021...

# 5. Read the actual measurement data
# If read() still fails, we try read_raw() to see exactly what the machine is sending
try:
    # Standard ASCII read
    data = instr.read()
    print("Measurement Data:")
    print(data)
except pyvisa.errors.VisaIOError:
    print("Standard read timed out. Trying raw read...")
    raw_data = instr.read_raw()
    print(raw_data)

instr.close()
